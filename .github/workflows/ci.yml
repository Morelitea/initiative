name: CI

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

jobs:
  backend-tests:
    name: Backend Tests & Lint
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: initiative
          POSTGRES_PASSWORD: initiative
          POSTGRES_DB: initiative_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U initiative"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql+asyncpg://initiative:initiative@localhost:5432/initiative_test
      SECRET_KEY: ${{ secrets.CI_SECRET_KEY }}
      AUTO_APPROVED_EMAIL_DOMAINS: '["example.com"]'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov ruff

      - name: Create database roles for RLS
        run: |
          PGPASSWORD=initiative psql -h localhost -U initiative -d initiative_test <<-'EOSQL'
            DO $$ BEGIN
              IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_user') THEN
                CREATE ROLE app_user WITH LOGIN NOINHERIT;
              END IF;
              IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'app_admin') THEN
                CREATE ROLE app_admin WITH LOGIN BYPASSRLS;
              END IF;
            END $$;
            GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
            GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;
            GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_admin;
            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO app_admin;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO app_admin;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO app_admin;
          EOSQL

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head

      - name: Lint with Ruff
        run: |
          cd backend
          ruff check app

      - name: Detect changed backend directories
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- backend/app/ || true)
          else
            CHANGED=$(git diff --name-only HEAD~1...HEAD -- backend/app/ || true)
          fi

          if [[ -z "$CHANGED" ]]; then
            echo "scope=app/" >> $GITHUB_OUTPUT
            echo "No changed files detected — running all tests"
            exit 0
          fi

          # Check if shared infra changed (requires full test run)
          if echo "$CHANGED" | grep -qE '(app/testing/|app/models/|app/core/|app/db/|conftest\.py)'; then
            echo "scope=app/" >> $GITHUB_OUTPUT
            echo "Shared infrastructure changed — running all tests"
          else
            # Extract unique directories and strip backend/ prefix
            DIRS=$(echo "$CHANGED" | sed 's|^backend/||' | xargs -I{} dirname {} | sort -u | tr '\n' ' ')
            echo "scope=$DIRS" >> $GITHUB_OUTPUT
            echo "Running tests in: $DIRS"
          fi

      - name: Run tests
        run: |
          cd backend
          python -m pytest ${{ steps.changes.outputs.scope }} -v --tb=short

  frontend-lint-and-test:
    name: Frontend Lint & Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: Lint
        run: |
          cd frontend
          pnpm lint

      - name: Run tests
        run: |
          cd frontend
          pnpm vitest run --passWithNoTests
