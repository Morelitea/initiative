services:
  db:
    image: postgres:17
    container_name: initiative-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-initiative}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-initiative}
      POSTGRES_DB: ${POSTGRES_DB:-initiative}
      # Passwords for RLS database roles (created by init script)
      APP_USER_PASSWORD: ${APP_USER_PASSWORD:-app_user_password}
      APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD:-app_admin_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Init script creates app_user and app_admin database roles
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/01-create-roles.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5

  initiative:
    # Use the published Docker image from Docker Hub
    # Available tags: latest, 0.1, 0.1.1, etc.
    # See: https://hub.docker.com/r/morelitea/initiative
    image: morelitea/initiative:latest
    container_name: initiative
    restart: unless-stopped
    volumes:
      - ./uploads:/app/uploads
    environment:
      # RLS-enforced connection (app_user role, no BYPASSRLS)
      DATABASE_URL_APP: postgresql+asyncpg://app_user:${APP_USER_PASSWORD:-app_user_password}@db:5432/${POSTGRES_DB:-initiative}
      # Admin connection for migrations and background jobs (app_admin role, BYPASSRLS)
      DATABASE_URL_ADMIN: postgresql+asyncpg://app_admin:${APP_ADMIN_PASSWORD:-app_admin_password}@db:5432/${POSTGRES_DB:-initiative}
      # Fallback URL (used if DATABASE_URL_APP not set; existing setups keep working)
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-initiative}:${POSTGRES_PASSWORD:-initiative}@db:5432/${POSTGRES_DB:-initiative}
      SECRET_KEY: super-secret-key
      ACCESS_TOKEN_EXPIRE_MINUTES: 10080
      APP_URL: ${APP_URL:-http://localhost:8173}
      # Optional: Enable OIDC authentication
      # OIDC_ENABLED: true
      # OIDC_DISCOVERY_URL: https://your-oidc-provider/.well-known/openid-configuration
      # OIDC_CLIENT_ID: your-client-id
      # OIDC_CLIENT_SECRET: your-client-secret
      # OIDC_PROVIDER_NAME: Your Provider Name
      # OIDC_SCOPES: openid,profile,email
      # Optional: Enable push notifications (requires Firebase project)
      # See docs/FIREBASE_SETUP.md for setup instructions
      # FCM_ENABLED: false
      # FCM_PROJECT_ID: your-firebase-project-id
      # FCM_APPLICATION_ID: 1:123456789:android:abcdef
      # FCM_API_KEY: AIzaSy...
      # FCM_SENDER_ID: 123456789
      # FCM_SERVICE_ACCOUNT_JSON: '{"type":"service_account","project_id":"..."}'
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8173:8173"

volumes:
  postgres_data:
    driver: local
